
# Pour l'Analyse de risques

def analyze_vulnerabilities(host):
    """
    Combine dÃ©tection technique ET analyse de risques
    """
    results = {
        "host": host["ip"],
        "technical_findings": [],
        "risk_assessment": {
            "level": "LOW",  # LOW, MEDIUM, HIGH, CRITICAL
            "score": 0,      # 0-10
            "details": []
        },
        "recommendations": []
    }
    
    # 1. DÃ‰TECTION TECHNIQUE
    for port in host.get("open_ports", []):
        # Chercher des vulnÃ©rabilitÃ©s connues
        vuln = check_known_vulnerabilities(port, host)
        if vuln:
            results["technical_findings"].append(vuln)
    
    # 2. ANALYSE DE RISQUES
    risk_level = calculate_risk_level(results["technical_findings"])
    results["risk_assessment"]["level"] = risk_level
    results["risk_assessment"]["score"] = calculate_risk_score(host)
    results["risk_assessment"]["details"] = generate_risk_details(results["technical_findings"])
    
    # 3. RECOMMANDATIONS
    results["recommendations"] = generate_recommendations(results)
    
    return results


def check_known_vulnerabilities(port, host):
    """
    VÃ©rifie les vulnÃ©rabilitÃ©s connues pour un port donnÃ©
    """
    # Base de donnÃ©es simplifiÃ©e des vulnÃ©rabilitÃ©s courantes
    VULN_DB = {
        21: {  # FTP
            "name": "FTP non sÃ©curisÃ©",
            "description": "Authentification et donnÃ©es transmises en clair",
            "risk": "MEDIUM",
            "cve": None,
            "recommendation": "Utiliser FTPS (FTP over SSL) ou SFTP"
        },
        22: {  # SSH
            "name": "SSH avec authentification par mot de passe",
            "description": "VulnÃ©rable aux attaques par bruteforce",
            "risk": "HIGH",
            "cve": None,
            "recommendation": "Utiliser des clÃ©s SSH et dÃ©sactiver l'authentification par mot de passe"
        },
        23: {  # Telnet
            "name": "Telnet actif",
            "description": "Toutes les donnÃ©es (mots de passe inclus) transmises en clair",
            "risk": "CRITICAL",
            "cve": None,
            "recommendation": "Remplacer par SSH immÃ©diatement"
        },
        80: {  # HTTP
            "name": "HTTP sans HTTPS",
            "description": "DonnÃ©es transmises sans chiffrement",
            "risk": "MEDIUM",
            "cve": None,
            "recommendation": "Rediriger vers HTTPS (port 443) et obtenir un certificat SSL"
        },
        3389: {  # RDP
            "name": "RDP exposÃ©",
            "description": "Port RDP accessible - cible courante pour les attaques",
            "risk": "CRITICAL",
            "cve": "CVE-2019-0708 (BlueKeep)",
            "recommendation": "Fermer le port ou utiliser un VPN pour l'accÃ¨s distant"
        },
        445: {  # SMB
            "name": "SMB partagÃ©",
            "description": "VulnÃ©rable aux attaques comme EternalBlue",
            "risk": "HIGH",
            "cve": "CVE-2017-0144 Ã  CVE-2017-0148",
            "recommendation": "Mettre Ã  jour Windows et restreindre les partages SMB"
        }
    }
    
    if port in VULN_DB:
        vuln_info = VULN_DB[port].copy()
        vuln_info["port"] = port
        
        # VÃ©rifications supplÃ©mentaires
        if port == 80:
            # Si le port 443 est aussi ouvert, le risque est moindre
            if 443 in host.get("open_ports", []):
                vuln_info["risk"] = "LOW"
                vuln_info["description"] += " (mais HTTPS aussi disponible)"
        
        elif port == 22:
            # VÃ©rifier si le port 22 est accessible depuis l'extÃ©rieur
            # (simplifiÃ©: on considÃ¨re que oui si on le scanne)
            vuln_info["description"] += " - Port accessible"
        
        return vuln_info
    
    return None


def calculate_risk_level(technical_findings):
    """
    DÃ©termine le niveau de risque global basÃ© sur les findings
    """
    if not technical_findings:
        return "LOW"
    
    # PrioritÃ© des niveaux de risque
    risk_priority = {"CRITICAL": 4, "HIGH": 3, "MEDIUM": 2, "LOW": 1}
    max_risk = "LOW"
    
    for finding in technical_findings:
        current_risk = finding.get("risk", "LOW")
        if risk_priority.get(current_risk, 0) > risk_priority.get(max_risk, 0):
            max_risk = current_risk
    
    return max_risk


def calculate_risk_score(host):
    """
    Calcule un score de risque de 0 Ã  10
    """
    open_ports = host.get("open_ports", [])
    score = 0
    
    # Points par port Ã  risque
    risk_points = {
        23: 3,   # Telnet - trÃ¨s risquÃ©
        3389: 3, # RDP - trÃ¨s risquÃ©
        445: 2,  # SMB - risquÃ©
        22: 2,   # SSH - risquÃ© si mal configurÃ©
        21: 1,   # FTP - moyen risque
        80: 1,   # HTTP - moyen risque
        443: 0,  # HTTPS - normal
        53: 0,   # DNS - normal
    }
    
    # Calcul du score
    for port in open_ports:
        score += risk_points.get(port, 0)
    
    # Normalisation Ã  10
    if score > 10:
        score = 10
    
    return score


def generate_risk_details(technical_findings):
    """
    GÃ©nÃ¨re des dÃ©tails sur l'analyse de risque
    """
    details = []
    
    if not technical_findings:
        details.append("Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e")
        return details
    
    # Compter les vulnÃ©rabilitÃ©s par niveau
    risk_counts = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}
    
    for finding in technical_findings:
        risk = finding.get("risk", "LOW")
        risk_counts[risk] += 1
    
    # GÃ©nÃ©rer le rÃ©sumÃ©
    for risk_level in ["CRITICAL", "HIGH", "MEDIUM", "LOW"]:
        count = risk_counts[risk_level]
        if count > 0:
            details.append(f"{count} vulnÃ©rabilitÃ©(s) de niveau {risk_level}")
    
    return details


def generate_recommendations(results):
    """
    GÃ©nÃ¨re des recommandations basÃ©es sur les rÃ©sultats
    """
    recommendations = []
    findings = results["technical_findings"]
    
    if not findings:
        recommendations.append("Aucune action urgente requise")
        recommendations.append("Maintenir les systÃ¨mes Ã  jour rÃ©guliÃ¨rement")
        return recommendations
    
    # Recommandations prioritaires
    for finding in findings:
        risk = finding.get("risk", "LOW")
        port = finding.get("port", 0)
        rec = finding.get("recommendation", "")
        
        if risk in ["CRITICAL", "HIGH"]:
            recommendations.append(f"[URGENT] Port {port}: {rec}")
        elif risk == "MEDIUM":
            recommendations.append(f"[IMPORTANT] Port {port}: {rec}")
        else:
            recommendations.append(f"[CONSEIL] Port {port}: {rec}")
    
    # Recommandations gÃ©nÃ©rales
    if results["risk_assessment"]["score"] >= 7:
        recommendations.append("[URGENT] Effectuer un audit de sÃ©curitÃ© complet")
    
    if any(f["risk"] == "CRITICAL" for f in findings):
        recommendations.append("[URGENT] Corriger les vulnÃ©rabilitÃ©s critiques dans les 24h")
    
    # Recommandation de base
    recommendations.append("[GÃ‰NÃ‰RAL] Mettre Ã  jour rÃ©guliÃ¨rement tous les logiciels")
    
    return recommendations


def display_vulnerability_report(results):
    """
    Affiche un rapport formatÃ© des vulnÃ©rabilitÃ©s
    """
    print(f"\n{'='*50}")
    print(f"RAPPORT D'ANALYSE POUR {results['host']}")
    print(f"{'='*50}")
    
    # Section 1: Ã‰valuation du risque
    print(f"\nğŸ“Š Ã‰VALUATION DU RISQUE")
    print(f"   Niveau : {results['risk_assessment']['level']}")
    print(f"   Score  : {results['risk_assessment']['score']}/10")
    
    if results['risk_assessment']['details']:
        print(f"   DÃ©tails :")
        for detail in results['risk_assessment']['details']:
            print(f"     â€¢ {detail}")
    
    # Section 2: DÃ©tections techniques
    print(f"\nğŸ” DÃ‰TECTIONS TECHNIQUES")
    if results['technical_findings']:
        for finding in results['technical_findings']:
            risk_emoji = {
                "CRITICAL": "ğŸ”´",
                "HIGH": "ğŸŸ ", 
                "MEDIUM": "ğŸŸ¡",
                "LOW": "ğŸŸ¢"
            }.get(finding['risk'], "âšª")
            
            print(f"\n   {risk_emoji} Port {finding['port']} - {finding['name']}")
            print(f"     Risque : {finding['risk']}")
            print(f"     Description : {finding['description']}")
            if finding.get('cve'):
                print(f"     CVE : {finding['cve']}")
            print(f"     Recommandation : {finding['recommendation']}")
    else:
        print("   âœ… Aucune vulnÃ©rabilitÃ© dÃ©tectÃ©e")
    
    # Section 3: Recommandations
    print(f"\nâœ… RECOMMANDATIONS")
    for i, rec in enumerate(results['recommendations'], 1):
        print(f"   {i}. {rec}")
    
    print(f"\n{'='*50}")